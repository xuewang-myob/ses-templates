name: Auto request Copilot review (VHNP)
on:
  pull_request:
    types: [opened, ready_for_review, synchronize]

jobs:
  copilot-review:
    if: startsWith(github.event.pull_request.head.ref, 'VHNP') && github.event.pull_request.draft == false
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write
      contents: read
    steps:
      - name: Show head/base branch
        run: |
          echo "Head: ${{ github.event.pull_request.head.ref }}"
          echo "Base: ${{ github.event.pull_request.base.ref }}"

      - name: Check existing requested reviewers
        id: check
        run: |
          PR=${{ github.event.pull_request.number }}
            REPO=${{ github.repository }}
          EXISTING=$(gh api /repos/$REPO/pulls/$PR/requested_reviewers --jq '.users[].login' || true)
          echo "Existing requested reviewers:"
          echo "$EXISTING"
          SHOULD_REQUEST=true
          for r in $EXISTING; do
            if [ "${r,,}" = "copilot" ]; then
              SHOULD_REQUEST=false
              break
            fi
          done
          echo "should_request=$SHOULD_REQUEST" >> $GITHUB_OUTPUT
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Request Copilot review
        if: steps.check.outputs.should_request == 'true'
        uses: octokit/request-action@v2
        with:
          route: POST /repos/${{ github.repository }}/pulls/${{ github.event.pull_request.number }}/requested_reviewers
          reviewers: '["Copilot"]'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Log skipped
        if: steps.check.outputs.should_request != 'true'
        run: echo "Copilot already requested; skipping."