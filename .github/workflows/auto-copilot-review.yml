name: Auto Enable Copilot Review

on:
  pull_request:
    types: [opened, reopened, synchronize]

jobs:
  trigger-copilot-review:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      issues: write
      pull-requests: write

    steps:
      - name: Check branch prefix (VHNP*)
        id: check-branch
        uses: actions/github-script@v7
        with:
          script: |
            const headRef = context.payload.pull_request.head.ref;
            console.log(`Source branch: ${headRef}`);

            const startsWithVHNP = headRef.toUpperCase().startsWith('VHNP');
            console.log(`Branch starts with VHNP: ${startsWithVHNP}`);

            return startsWithVHNP;

      - name: Trigger Copilot Review
        if: steps.check-branch.outputs.result == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const pull_number = context.payload.pull_request.number;

            // 1. 获取已有评论，避免重复触发
            const existingComments = await github.paginate(
              github.rest.issues.listComments,
              { owner, repo, issue_number: pull_number, per_page: 100 }
            );

            const alreadyTriggered = existingComments.some(c =>
              typeof c.body === 'string' &&
              c.body.toLowerCase().includes('@copilot review')
            );

            if (alreadyTriggered) {
              console.log('Detected existing @copilot review comment, skip creating a new one.');
              return;
            }

            // 2. 仅留下触发审查的评论，明确不让它创建新 PR
            const body = [
              '@copilot review',
              '',
              '🤖 自动触发：源分支名称以 "VHNP" 开头。',
              '请仅进行代码审查并留下AI Review Result的Comment，不要创建新的分支或新的PR'
            ].join('\n');

            await github.rest.issues.createComment({
              owner,
              repo,
              issue_number: pull_number,
              body
            });

            console.log('Posted @copilot review comment successfully.')

      - name: Skip Copilot Review
        if: steps.check-branch.outputs.result != 'true'
        run: |
          echo "Branch does not start with VHNP. Copilot review will not be triggered."
