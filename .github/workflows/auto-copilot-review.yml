name: Auto Enable Copilot Review

on:
  pull_request:
    types: [opened, reopened, synchronize]

jobs:
  check-and-enable-copilot:
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write
      contents: read

    steps:
      - name: Check if branch starts with VHNP
        id: check-branch
        uses: actions/github-script@v7
        with:
          script: |
            const headRef = context.payload.pull_request.head.ref;
            console.log(`Source branch: ${headRef}`);

            const startsWithVHNP = headRef.toUpperCase().startsWith('VHNP');
            console.log(`Branch starts with VHNP: ${startsWithVHNP}`);

            return startsWithVHNP;

      - name: Request Copilot Reviewer
        if: steps.check-branch.outputs.result == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const pull_number = context.payload.pull_request.number;

            // å¦‚æœå®é™…çš„ Copilot reviewer login ä¸ä¸‹é¢ä¸åŒï¼Œè¯·æ›¿æ¢
            const copilotReviewerLogin = 'Copilot';

            try {
              // è·å–å½“å‰ PRï¼ŒæŸ¥çœ‹æ˜¯å¦å·²ç»è¯·æ±‚è¿‡ Copilot
              const { data: pull } = await github.rest.pulls.get({
                owner,
                repo,
                pull_number
              });

              const alreadyRequested = pull.requested_reviewers
                ?.some(r => r.login === copilotReviewerLogin);

              if (alreadyRequested) {
                console.log(`Copilot (${copilotReviewerLogin}) å·²ç»æ˜¯è¯·æ±‚çš„ reviewerï¼Œè·³è¿‡å†æ¬¡è¯·æ±‚ã€‚`);
                return;
              }

              // è¯·æ±‚æ·»åŠ  Copilot ä½œä¸º reviewer
              await github.rest.pulls.requestReviewers({
                owner,
                repo,
                pull_number,
                reviewers: [copilotReviewerLogin]
              });

              console.log('æˆåŠŸé€šè¿‡ API è¯·æ±‚ Copilot ä½œä¸º reviewerã€‚');

              // æ·»åŠ è¯´æ˜æ€§è¯„è®ºï¼ˆå¯é€‰ï¼‰
              await github.rest.issues.createComment({
                owner,
                repo,
                issue_number: pull_number,
                body: `ğŸ¤– å·²è‡ªåŠ¨ä¸ºæ­¤ PR è¯·æ±‚ Copilot ( ${copilotReviewerLogin} ) ä»£ç å®¡æŸ¥ï¼Œå› ä¸ºæºåˆ†æ”¯åä»¥ "VHNP" å¼€å¤´ã€‚`
              });

            } catch (error) {
              console.error('è¯·æ±‚ Copilot reviewer å¤±è´¥ï¼š', error.message);

              // å›é€€ï¼šæ·»åŠ ä¸€æ¡è§¦å‘è¯­å¥è¯„è®º
              try {
                await github.rest.issues.createComment({
                  owner,
                  repo,
                  issue_number: pull_number,
                  body: '@copilot review\n\n(è‡ªåŠ¨æµç¨‹å›é€€ï¼šç›´æ¥è¯·æ±‚ reviewer å¤±è´¥ï¼Œæ”¹ä¸ºè¯„è®ºè§¦å‘ã€‚)'
                });
                console.log('å·²é€šè¿‡è¯„è®ºå°è¯•è§¦å‘ Copilot reviewã€‚');
              } catch (commentError) {
                console.error('æ·»åŠ å›é€€è¯„è®ºä¹Ÿå¤±è´¥ï¼š', commentError.message);
                throw commentError;
              }
            }

      - name: Skip Copilot Review
        if: steps.check-branch.outputs.result != 'true'
        run: |
          echo "Source branch does not start with VHNP. Copilot review will not be requested."
